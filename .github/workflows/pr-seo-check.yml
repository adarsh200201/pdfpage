name: 🔍 PR SEO Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'public/**'
      - '*.html'
      - '*.tsx'
      - '*.jsx'

jobs:
  seo-check:
    name: 🔍 SEO Analysis for PR
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'seo-automation/package-lock.json'
      
      - name: 🔧 Install dependencies
        run: |
          cd seo-automation
          npm ci
      
      - name: 🔍 Run SEO analysis on changed files
        id: seo-analysis
        run: |
          cd seo-automation
          echo "🔍 Running SEO analysis for PR..."
          npm run seo-enhanced > seo-output.log 2>&1 || true
          
          # Extract key metrics
          if [ -f "comprehensive-seo-report.json" ]; then
            SCORE=$(jq -r '.summary.averageScore // "N/A"' comprehensive-seo-report.json)
            IMPROVEMENTS=$(jq -r '.summary.totalImprovements // "N/A"' comprehensive-seo-report.json)
            FILES=$(jq -r '.summary.totalFiles // "N/A"' comprehensive-seo-report.json)
            
            echo "score=$SCORE" >> $GITHUB_OUTPUT
            echo "improvements=$IMPROVEMENTS" >> $GITHUB_OUTPUT
            echo "files=$FILES" >> $GITHUB_OUTPUT
          else
            echo "score=N/A" >> $GITHUB_OUTPUT
            echo "improvements=N/A" >> $GITHUB_OUTPUT
            echo "files=N/A" >> $GITHUB_OUTPUT
          fi
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      
      - name: 📋 Create PR comment with SEO results
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.seo-analysis.outputs.score }}';
            const improvements = '${{ steps.seo-analysis.outputs.improvements }}';
            const files = '${{ steps.seo-analysis.outputs.files }}';
            
            let scoreEmoji = '📊';
            let scoreColor = '';
            
            if (score !== 'N/A') {
              const numScore = parseFloat(score);
              if (numScore >= 90) {
                scoreEmoji = '🎉';
                scoreColor = '🟢';
              } else if (numScore >= 80) {
                scoreEmoji = '✅';
                scoreColor = '🟡';
              } else if (numScore >= 70) {
                scoreEmoji = '⚠️';
                scoreColor = '🟠';
              } else {
                scoreEmoji = '🚨';
                scoreColor = '🔴';
              }
            }
            
            const body = `## ${scoreEmoji} SEO Analysis Results
            
            ${scoreColor} **SEO Score:** ${score}/100
            📁 **Files Analyzed:** ${files}
            🔧 **Improvements Found:** ${improvements}
            
            ### Summary
            ${score !== 'N/A' && parseFloat(score) < 80 ? 
              '⚠️ **SEO improvements recommended** - Consider addressing the identified issues before merging.' :
              '✅ **Good SEO health** - This PR maintains good SEO practices.'
            }
            
            ### Next Steps
            - 📊 Review the detailed SEO analysis in the workflow artifacts
            - 🔧 Address high-priority issues if SEO score is below 80
            - 🚀 Merge when SEO guidelines are met
            
            ---
            *Automated by Enhanced SEO Automation - Powered by Gemini AI*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: 📊 Upload SEO analysis artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-seo-analysis-${{ github.event.number }}
          path: |
            seo-automation/comprehensive-seo-report.json
            seo-automation/seo-report-readable.md
            seo-automation/seo-output.log
          retention-days: 14
      
      - name: ❌ Fail if SEO score is too low
        if: steps.seo-analysis.outputs.score != 'N/A' && steps.seo-analysis.outputs.score < 60
        run: |
          echo "🚨 SEO score (${{ steps.seo-analysis.outputs.score }}) is below minimum threshold (60)"
          echo "Please address critical SEO issues before merging"
          exit 1
